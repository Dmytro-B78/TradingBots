# ============================================
# СЂСџвЂњРѓ File: plot_equity_curve.py
# СЂСџвЂњРЉ Р СњР В°Р В·Р Р…Р В°РЎвЂЎР ВµР Р…Р С‘Р Вµ: Р СџР С•РЎРѓРЎвЂљРЎР‚Р С•Р ВµР Р…Р С‘Р Вµ Р С”РЎР‚Р С‘Р Р†Р С•Р в„– Р С”Р В°Р С—Р С‘РЎвЂљР В°Р В»Р В° Р С—Р С• trades_log.csv
# СЂСџвЂњВ¦ Р вЂ”Р В°Р Р†Р С‘РЎРѓР С‘Р СР С•РЎРѓРЎвЂљР С‘: pandas, matplotlib
# СЂСџвЂњвЂљ Р С›Р В¶Р С‘Р Т‘Р В°Р ВµР СРЎвЂ№Р в„– Р С—РЎС“РЎвЂљРЎРЉ Р С” РЎвЂћР В°Р в„–Р В»РЎС“: state/trades_log.csv
# РІСљвЂ¦ Р вЂ™Р ВµРЎР‚РЎРѓР С‘РЎРЏ: 2026-01-18 00:15
# ============================================

import pandas as pd
import matplotlib.pyplot as plt
import os

# --------------------------------------------
# СЂСџвЂњвЂљ Р С’Р В±РЎРѓР С•Р В»РЎР‹РЎвЂљР Р…РЎвЂ№Р в„– Р С—РЎС“РЎвЂљРЎРЉ Р С” РЎвЂћР В°Р в„–Р В»РЎС“ РЎРѓР Т‘Р ВµР В»Р С•Р С”
# --------------------------------------------
log_path = os.path.join("state", "trades_log.csv")

# --------------------------------------------
# СЂСџвЂќРЊ Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚Р С”Р В° Р Р…Р В°Р В»Р С‘РЎвЂЎР С‘РЎРЏ РЎвЂћР В°Р в„–Р В»Р В°
# --------------------------------------------
if not os.path.exists(log_path):
    print("РІСњРЉ Р В¤Р В°Р в„–Р В» trades_log.csv Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р… Р С—Р С• Р С—РЎС“РЎвЂљР С‘:", log_path)
    exit()

# --------------------------------------------
# СЂСџвЂњР‰ Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° Р С‘ Р С—Р С•Р Т‘Р С–Р С•РЎвЂљР С•Р Р†Р С”Р В° Р Т‘Р В°Р Р…Р Р…РЎвЂ№РЎвЂ¦
# --------------------------------------------
df = pd.read_csv(log_path)

# СЂСџвЂўвЂ™ Р СџРЎР‚Р ВµР С•Р В±РЎР‚Р В°Р В·Р С•Р Р†Р В°Р Р…Р С‘Р Вµ Р Р†РЎР‚Р ВµР СР ВµР Р…Р С‘ (Р ВµРЎРѓР В»Р С‘ Р ВµРЎРѓРЎвЂљРЎРЉ Р С”Р С•Р В»Р С•Р Р…Р С”Р В° 'time')
if "time" in df.columns:
    try:
        df["time"] = pd.to_datetime(df["time"], unit="ms", errors="coerce")
    except:
        df["time"] = pd.to_datetime(df["time"], errors="coerce")
else:
    print("РІС™В РїС‘РЏ Р С™Р С•Р В»Р С•Р Р…Р С”Р В° 'time' Р Р…Р Вµ Р Р…Р В°Р в„–Р Т‘Р ВµР Р…Р В°. Р ВРЎРѓР С—Р С•Р В»РЎРЉР В·РЎС“РЎР‹ Р С‘Р Р…Р Т‘Р ВµР С”РЎРѓ Р С”Р В°Р С” Р С•РЎРѓРЎРЉ X.")
    df["time"] = range(len(df))

# --------------------------------------------
# СЂСџвЂ™В° Р В Р В°РЎРѓРЎвЂЎРЎвЂРЎвЂљ equity Р С‘ Р С—РЎР‚Р С•РЎРѓР В°Р Т‘Р С”Р С‘
# --------------------------------------------
df = df.sort_values("time").reset_index(drop=True)
df["pnl_cumsum"] = df["pnl"].cumsum()
df["equity"] = 10000 + df["pnl_cumsum"]
df["peak"] = df["equity"].cummax()
df["drawdown"] = df["equity"] - df["peak"]
df["drawdown_pct"] = df["drawdown"] / df["peak"] * 100

# --------------------------------------------
# СЂСџвЂ“СРїС‘РЏ Р СџР С•РЎРѓРЎвЂљРЎР‚Р С•Р ВµР Р…Р С‘Р Вµ Р С–РЎР‚Р В°РЎвЂћР С‘Р С”Р В°
# --------------------------------------------
plt.figure(figsize=(12, 6))
plt.plot(df["time"], df["equity"], label="Equity", color="green")
plt.fill_between(df["time"], df["equity"], df["peak"], color="red", alpha=0.2, label="Drawdown")
plt.title("СЂСџвЂњв‚¬ Equity Curve")
plt.xlabel("Time")
plt.ylabel("Equity (USDT)")
plt.legend()
plt.grid(True)
plt.tight_layout()
plt.show()

